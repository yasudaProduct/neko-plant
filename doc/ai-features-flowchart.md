# AI機能のフローチャート

## 1. 植物登録フロー（AI識別機能統合後）

```
┌─────────────────────┐
│ ユーザーが植物登録  │
│ ページにアクセス    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 画像をアップロード  │
│ （オプション）      │
└──────────┬──────────┘
           │
           ├─画像なし─────────────────┐
           │                          │
           ▼                          │
┌─────────────────────┐              │
│ AI識別を実行         │              │
└──────────┬──────────┘              │
           │                          │
           ▼                          │
┌─────────────────────┐              │
│ 識別結果を取得       │              │
│ • 候補リスト         │              │
│ • 信頼度スコア       │              │
└──────────┬──────────┘              │
           │                          │
           ▼                          │
┌─────────────────────┐              │
│ 既存植物との照合     │              │
│ • 学名での完全一致   │              │
│ • 名前のファジー一致 │              │
└──────────┬──────────┘              │
           │                          │
           ├─重複なし─────────────┐   │
           │                      │   │
           ▼                      │   │
┌─────────────────────┐          │   │
│ 重複の可能性あり     │          │   │
│ 候補を表示           │          │   │
└──────────┬──────────┘          │   │
           │                      │   │
           ▼                      │   │
┌─────────────────────┐          │   │
│ ユーザーに確認       │          │   │
│ 「同じ植物ですか？」 │          │   │
└──────────┬──────────┘          │   │
           │                      │   │
      ┌────┴────┐               │   │
      │         │               │   │
   [同じ]    [異なる]           │   │
      │         │               │   │
      │         └─────────────┐ │   │
      ▼                       │ │   │
┌─────────────────────┐       │ │   │
│ 既存植物ページへ     │       │ │   │
│ リダイレクト         │       │ │   │
└─────────────────────┘       │ │   │
                              │ │   │
                              ▼ ▼   ▼
                        ┌──────────────────┐
                        │ AI候補を植物名に  │
                        │ 自動入力（編集可） │
                        └────────┬─────────┘
                                 │
                                 ▼
                        ┌──────────────────┐
                        │ ユーザーが名前を  │
                        │ 確認・編集        │
                        └────────┬─────────┘
                                 │
                                 ▼
                        ┌──────────────────┐
                        │ 植物を登録        │
                        └──────────────────┘
```

## 2. 画像アップロードフロー（AI分類機能統合後）

```
┌─────────────────────┐
│ ユーザーが植物画像  │
│ をアップロード       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 画像をストレージに   │
│ 一時保存             │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ AI画像分析を実行     │
│ • ラベル検出         │
│ • オブジェクト検出   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 画像を分類           │
│                     │
│ 1. 植物のみ         │
│ 2. 猫のみ           │
│ 3. 植物と猫の両方   │
│ 4. どちらでもない   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 信頼度スコアを評価   │
└──────────┬──────────┘
           │
      ┌────┴────────────────┐
      │                     │
      ▼                     ▼
┌──────────────┐    ┌──────────────┐
│ 高信頼度       │    │ 低信頼度      │
│ (>0.9-0.95)   │    │ (<0.9)       │
└──────┬───────┘    └──────┬───────┘
       │                    │
       ▼                    ▼
┌──────────────┐    ┌──────────────┐
│ 分類別に判定   │    │ 手動レビュー  │
│               │    │ 対象に設定    │
│ 植物+猫: 自動承認│   │              │
│ 植物のみ: 自動承認│ └──────────────┘
│ 猫のみ: 手動     │
│ なし: 手動       │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 表示優先度を計算│
│               │
│ 植物+猫: 100-200│
│ 植物: 50-150    │
│ 猫: 25-125      │
│ なし: 0         │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ DBに保存       │
│ • 分類情報     │
│ • 信頼度       │
│ • 承認状態     │
│ • 優先度       │
└──────┬───────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌──────┐ ┌──────────┐
│ 自動承認│ │ 管理者承認 │
│ → 公開 │ │ 待ち       │
└──────┘ └──────────┘
```

## 3. 管理者モデレーションフロー（改善後）

```
┌─────────────────────┐
│ 管理者が承認ページ  │
│ にアクセス           │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 未承認画像を表示     │
│ （優先度順）         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ AI分析結果を表示     │
│                     │
│ 🏷️ 分類: 植物+猫     │
│ 📊 信頼度: 92%      │
│ ✅ 含まれる: 植物、猫│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 管理者が判断         │
└──────────┬──────────┘
           │
      ┌────┴────┐
      │         │
   [承認]    [拒否]
      │         │
      ▼         ▼
┌──────────┐ ┌──────────┐
│ 画像を公開 │ │ 画像を削除 │
│ 優先表示   │ │ ユーザーに │
└──────────┘ │ 通知       │
              └──────────┘

💡 AI自動承認により、
   70%の画像は管理者の
   レビュー不要になる
```

## 4. 重複チェックフロー（ファジーマッチング）

```
┌─────────────────────┐
│ 植物名を入力/AI提案  │
│ 例: "ポトス"         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 完全一致チェック     │
│ (既存機能)           │
└──────────┬──────────┘
           │
      ┌────┴────┐
      │         │
   [一致]    [不一致]
      │         │
      ▼         ▼
┌──────────┐ ┌─────────────────────┐
│ エラー表示│ │ ファジーマッチング   │
│ 重複です  │ │ (新機能)             │
└──────────┘ │                     │
              │ SELECT *            │
              │ FROM plants         │
              │ WHERE similarity(   │
              │   name, 'ポトス'    │
              │ ) > 0.3             │
              └──────────┬──────────┘
                         │
                    ┌────┴────┐
                    │         │
                 [類似なし] [類似あり]
                    │         │
                    ▼         ▼
              ┌──────────┐ ┌─────────────────┐
              │ 新規登録  │ │ 類似候補を表示   │
              │ を許可    │ │                 │
              └──────────┘ │ "オウゴンカズラ"│
                            │ (85% 類似)      │
                            │                 │
                            │ "ポトス・ライム" │
                            │ (70% 類似)      │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ ユーザーに確認   │
                            │ 「同じ植物？」   │
                            └────────┬────────┘
                                     │
                                ┌────┴────┐
                                │         │
                             [同じ]    [異なる]
                                │         │
                                ▼         ▼
                          ┌──────────┐ ┌──────────┐
                          │ 既存植物へ│ │ 新規登録  │
                          │ 誘導      │ │ を許可    │
                          └──────────┘ └──────────┘
```

## 5. 表示優先度による画像ソート

```
植物詳細ページ
┌─────────────────────────────────┐
│ 植物名: ポトス                   │
├─────────────────────────────────┤
│                                 │
│  ┌─────────┐  ← 優先度: 195    │
│  │ 🌿 + 🐱 │     分類: 植物+猫   │
│  │         │     信頼度: 95%    │
│  └─────────┘                    │
│                                 │
│  ┌─────────┐  ← 優先度: 192    │
│  │ 🌿 + 🐱 │     分類: 植物+猫   │
│  │         │     信頼度: 92%    │
│  └─────────┘                    │
│                                 │
│  ┌─────────┐  ← 優先度: 145    │
│  │   🌿    │     分類: 植物のみ  │
│  │         │     信頼度: 95%    │
│  └─────────┘                    │
│                                 │
│  ┌─────────┐  ← 優先度: 118    │
│  │   🐱    │     分類: 猫のみ    │
│  │         │     信頼度: 93%    │
│  └─────────┘                    │
│                                 │
└─────────────────────────────────┘

💡 ユーザーは最も関連性の高い
   画像（植物+猫）を最初に見る
```

## 6. システム全体のデータフロー

```
┌──────────────────────────────────────────────────────────┐
│                     フロントエンド (Next.js)              │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 植物登録ページ│  │ 画像アップロード│ │ 管理者ページ │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
└─────────┼─────────────────┼─────────────────┼──────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌──────────────────────────────────────────────────────────┐
│                  Server Actions (Next.js)                │
│                                                          │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │ identifyPlant    │  │ classifyImage    │            │
│  │ FromImage        │  │                  │            │
│  └────────┬─────────┘  └────────┬─────────┘            │
└───────────┼──────────────────────┼──────────────────────┘
            │                      │
            ▼                      ▼
┌──────────────────────────────────────────────────────────┐
│                   AI ライブラリ層                         │
│                                                          │
│  ┌──────────────────┐  ┌──────────────────┐            │
│  │ plant-           │  │ image-           │            │
│  │ identification.ts│  │ classification.ts│            │
│  └────────┬─────────┘  └────────┬─────────┘            │
└───────────┼──────────────────────┼──────────────────────┘
            │                      │
            └──────────┬───────────┘
                       │
                       ▼
            ┌──────────────────┐
            │ Google Cloud     │
            │ Vision API       │
            └──────────────────┘
                       │
                       │ 分析結果
                       ▼
┌──────────────────────────────────────────────────────────┐
│                  データベース (PostgreSQL)                │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ plants       │  │ plant_images │  │ plant_ai_    │  │
│  │              │  │              │  │ identifications│ │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                          │
│  ┌──────────────────────────────────────────────┐      │
│  │ PostgreSQL拡張: pg_trgm                       │      │
│  │ (ファジーマッチング用)                         │      │
│  └──────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────┘
```

## 7. AI APIコール最適化フロー

```
画像アップロード
      │
      ▼
┌─────────────┐
│ 画像ハッシュ │
│ を計算       │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ キャッシュに │
│ 結果がある？ │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
 [はい]  [いいえ]
   │       │
   │       ▼
   │   ┌─────────────┐
   │   │ 画像を最適化 │
   │   │ (リサイズ)   │
   │   └──────┬──────┘
   │          │
   │          ▼
   │   ┌─────────────┐
   │   │ Vision API  │
   │   │ を呼び出し   │
   │   └──────┬──────┘
   │          │
   │          ▼
   │   ┌─────────────┐
   │   │ 結果をキャッシュ│
   │   │ に保存       │
   │   └──────┬──────┘
   │          │
   └──────────┼──────┐
              │      │
              ▼      ▼
        ┌─────────────┐
        │ 結果を返す   │
        └─────────────┘

💡 同じ画像の再分析を防ぎ、
   APIコストを削減
```

---

**注記：**
- 🌿 = 植物
- 🐱 = 猫
- ✅ = 承認済み
- ⏳ = 処理中
- ❌ = 拒否/エラー

これらのフローチャートは、AI機能統合後のシステムの動作を視覚的に示しています。
実装時の参考資料としてご活用ください。
